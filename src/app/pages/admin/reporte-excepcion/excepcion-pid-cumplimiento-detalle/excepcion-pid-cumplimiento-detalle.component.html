<div class="relative overflow-x-auto">
<app-title titulo="Excepción del personal a cargo de {{EvaluatorName}} - {{PeriodName}}"></app-title>
<div class="max-w-[22rem] mx-auto p-4 bg-white rounded-lg shadow-md border border-gray-300 rounded-md mb-6">
<div class="flex items-center justify-center">
      <div *ngIf="Tipo != undefined" style="height: 53px; margin-right: 0.5rem;">
        <mat-form-field style="width: 195px;">
          <mat-select placeholder="Tipo" [(ngModel)]="Tipo">
            <mat-option value="PID">PID</mat-option>
            <mat-option value="CUMPLIMIENTO">CUMPLIMIENTO DE PID</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <button style="width: 107.42px;" (click)="FilterData()"  class="items-center justify-center py-2 bg-blue-600 text-white rounded-md flex items-center hover:bg-blue-700 transition-colors duration-200">
        <svg class="w-5 h-5 text-white"  xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
          <path stroke="currentColor" stroke-linecap="round" stroke-width="2" d="m21 21-3.5-3.5M17 10a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z"/>
        </svg>  
        Buscar              
      </button>
</div>  
</div>

<app-targetscounters
*ngIf="Activatetable"
[DataToCount]="DataList.registros"
[ConfirmedEntryName]="DataType === 'PID' ? 'estadoVeredicto' : 'estadoVeredicto'"
[ConfirmText]="DataType === 'PID' ? 'PID aprobados' : 'Cumplimiento de PID aprobados'"
[NotConfirmedText]="DataType === 'PID' ? 'PID no aprobados' : 'Cumplimiento de PID no aprobados'">
</app-targetscounters>

<div *ngIf="Activatetable && (Tipo === 'PID' || Tipo === 'CUMPLIMIENTO')" class="relative overflow-x-auto">
<table class="w-full text-sm text-left rtl:text-right text-gray-500 border solid">
    <thead class="text-xs text-gray-700 uppercase bg-gray-5">
        <tr>
            <th scope="col" class="px-6 py-3 border" style="width: 2rem;">
                <!-- Columna para la flecha -->
            </th>
            <th scope="col" class="px-6 py-3 border" style="width: 8rem;">Foto</th>
            <th scope="col" class="px-6 py-3 border" style="width: 5.9rem;">COD. FICHA</th>
            <th scope="col" class="px-6 py-3 border" style="width: 35rem;">APELLIDOS Y NOMBRES</th>
            <th scope="col" class="px-6 py-3 border" style="width: 8.5rem;">UNIDAD ORGÁNICA</th>
            <th scope="col" class="px-6 py-3 border" style="width: 6.8rem;">COD. PUESTO</th>
            <th scope="col" class="px-6 py-3 border text-wrap" style="width: 35rem;">PUESTO</th>
            <th scope="col" class="px-6 py-3 border text-center" style="width: 10rem;">Fecha límite</th>
            <th scope="col" class="px-6 py-3 border" style="width: 10rem;">
                {{ DataType === 'PID' ? 'ESTADO DE PID' : 'ESTADO DE CUMPLIMIENTO DE PID' }}
            </th>
            <th scope="col" class="px-6 py-3 border" style="width: 15rem;">Acciones</th>
        </tr>
    </thead>
    <tbody>
        <ng-container *ngFor="let item of DataList.registros" >
        <tr class="border hover:bg-gray-100">
            <td class="px-2 py-4 text-center" (click)="item?.evaluado?.codigoFicha && toggleRowExpansion(item?.evaluado?.codigoFicha)">
                <span class="inline-block transition-transform duration-200" [ngClass]="{'rotate-180': isRowExpanded(item?.evaluado?.codigoFicha)}">
                  <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down h-4 w-4">
                    <path d="m6 9 6 6 6-6"></path>
                  </svg>
                </span>
            </td>
            <th class="px-6 py-4 text-black border">
                <img class="w-20 h-20" [src]="item?.evaluado?.foto" loading="lazy" 
                crossorigin="anonymous" (error)="onImgError($event)" alt="Foto">
            </th>
            <th class="px-6 py-4 text-gray-900 whitespace-nowrap">
                <div class="text-base font-semibold"> {{ removeLeadingZeros(item.evaluado?.codigoFicha) }}</div>
            </th>
            <td class="px-6 py-4 text-black border">{{item?.evaluado?.apellidosNombres}}</td>
            <td class="px-6 py-4 text-black border">{{item?.evaluado?.unidadOrganica}}</td>
            <td class="px-6 py-4 text-black border">{{item?.evaluado?.codigoPuesto}}</td>
            <td class="px-6 py-4 text-black border">{{item?.evaluado?.nombrePuesto}}</td>
            <td *ngIf="DataType === 'PID'" [ngClass]="getStatusClass(item?.fechaLimite,item?.estadoEvaluado,item?.estadoEvaluador,item?.estadoVeredicto)" class="px-6 py-4 text-black border text-center">{{item?.fechaLimite | date:'dd/MM/yyyy'}}</td>    
            <td *ngIf="DataType === 'CUMPLIMIENTO'" [ngClass]="getStatusClass(item?.fechaLimite,item?.estadoEvaluado,item?.estadoEvaluador,item?.estadoVeredicto)" class="px-6 py-4 text-black border text-center">{{item?.fechaLimite | date:'dd/MM/yyyy'}}</td>    
            <td class="px-6 py-4 text-black border">
                <div *ngIf="DataType === 'PID'">
                    <div *ngIf="item?.estadoEvaluado && item?.estadoEvaluador && item?.estadoVeredicto" class="flex items-center">
                        <span class="badgegreen bg-green-500 w-full">APROBADO</span>
                    </div>
                    <div *ngIf="item?.estadoEvaluado && item?.estadoEvaluador && !item?.estadoVeredicto" class="flex items-center">
                        <span class="badgered bg-red-500 w-full">RECHAZADO</span>
                    </div>
                    <div *ngIf="item?.estadoEvaluado && !item?.estadoEvaluador && !item?.estadoVeredicto" class="flex items-center">
                        <span class="badgered bg-blue-500 w-full">REGISTRADO</span>
                    </div>
                    <div *ngIf="!item?.estadoEvaluado && !item?.estadoEvaluador && !item?.estadoVeredicto" class="flex items-center">
                        <span class="badgered bg-orange-500 w-full">NO REGISTRADO</span>
                    </div>
                </div>
                <div *ngIf="DataType === 'CUMPLIMIENTO'">
                    <div *ngIf="item?.estadoEvaluado && item?.estadoEvaluador && item?.estadoVeredicto" class="flex items-center">
                        <span class="badgegreen bg-green-500">CUMPLIMIENTO DE PID APROBADO</span>
                    </div>
                    <div *ngIf="item?.estadoEvaluado && item?.estadoEvaluador && !item?.estadoVeredicto" class="flex items-center">
                        <span class="badgered bg-red-500">CUMPLIMIENTO DE PID RECHAZADO</span>
                    </div>
                    <div *ngIf="item?.estadoEvaluado && !item?.estadoEvaluador && !item?.estadoVeredicto" class="flex items-center">
                        <span class="badgered bg-blue-500">CUMPLIMIENTO DE PID REGISTRADO</span>
                    </div>
                    <div *ngIf="!item?.estadoEvaluado && !item?.estadoEvaluador && !item?.estadoVeredicto" class="flex items-center">
                        <span class="badgered bg-orange-500">CUMPLIMIENTO DE PID NO REGISTRADO</span>
                    </div>
                </div>
            </td>
            <td class="px-6 py-4 text-black border">
                <div class="flex space-x-2">
                    <button *ngIf="DataType === 'PID' && item?.estadoEvaluado && item?.estadoEvaluador"
                            [routerLink]="['/home/ver-pid-evaluado-excepcion-reporteavance','EVALUATED',item?.evaluado?.codigoPuesto,this.CalendarCode,item?.evaluado?.codigoFicha]"
                            class="text-white bg-green-500 hover:bg-green-600 font-medium rounded-lg text-sm px-2.5 py-2.5 w-full">Ver PID</button>
                    
                    <button *ngIf="DataType === 'PID' && item?.estadoEvaluado && !item?.estadoEvaluador"
                            [routerLink]="['/home/ver-pid-evaluado-excepcion-reporteavance','EVALUATED',item?.evaluado?.codigoPuesto,this.CalendarCode,item?.evaluado?.codigoFicha]"
                            class="text-white bg-green-500 hover:bg-green-600 font-medium rounded-lg text-sm px-2.5 py-2.5 w-full">Ver PID</button>

                    <button (click)="NotifyEvaluated(item?.evaluado?.apellidosNombres,item?.evaluado?.codigoFicha)" *ngIf="DataType === 'PID' && (item?.estadoEvaluado && item?.estadoEvaluador && !item?.estadoVeredicto) && !ReturnFormatedStatusDate(item?.fechaLimite).isPast"
                            class="text-white bg-blue-500 hover:bg-blue-600 font-medium rounded-lg text-sm px-2.5 py-2.5 w-full">Notificar evaluado</button>
                    
                    <button (click)="NotifyEvaluator(item?.evaluador?.apellidosNombres,item?.evaluador?.codigoFicha)" *ngIf="DataType === 'PID' && (item?.estadoEvaluado && !item?.estadoEvaluador && !item?.estadoVeredicto) && !ReturnFormatedStatusDate(item?.fechaLimite).isPast"
                            class="text-white bg-blue-500 hover:bg-blue-600 font-medium rounded-lg text-sm px-2.5 py-2.5 w-full">Notificar evaluador</button>

                    <button (click)="NotifyEvaluated(item?.evaluado?.apellidosNombres,item?.evaluado?.codigoFicha)" *ngIf="DataType === 'PID' && (!item?.estadoEvaluado && !item?.estadoEvaluador && !item?.estadoVeredicto) && !ReturnFormatedStatusDate(item?.fechaLimite).isPast"
                            class="text-white bg-blue-500 hover:bg-blue-600 font-medium rounded-lg text-sm px-2.5 py-2.5 w-full">Notificar evaluado</button>
                    
                    <button *ngIf="DataType === 'CUMPLIMIENTO' && item?.estadoEvaluado && item?.estadoEvaluador"
                            [routerLink]="['/home/ver-cumplimiento-pid-evaluado-excepcion-reporteavance','EVALUATED',item?.evaluado?.codigoPuesto,this.CalendarCode,item?.evaluado?.codigoFicha]"
                            class="text-white bg-green-500 hover:bg-green-600 font-medium rounded-lg text-sm px-2.5 py-2.5 w-full">Ver cumplimiento</button>
                  
                    <button *ngIf="DataType === 'CUMPLIMIENTO' && item?.estadoEvaluado && !item?.estadoEvaluador"
                            [routerLink]="['/home/ver-cumplimiento-pid-evaluado-excepcion-reporteavance','EVALUATED',item?.evaluado?.codigoPuesto,this.CalendarCode,item?.evaluado?.codigoFicha]"
                            class="text-white bg-green-500 hover:bg-green-600 font-medium rounded-lg text-sm px-2.5 py-2.5 w-full">Ver cumplimiento</button>

                    <button (click)="NotifyEvaluated(item?.evaluado?.apellidosNombres,item?.evaluado?.codigoFicha)" *ngIf="DataType === 'CUMPLIMIENTO' && (item?.estadoEvaluado && item?.estadoEvaluador && !item?.estadoVeredicto) && !ReturnFormatedStatusDate(item?.fechaLimite).isPast"
                            class="text-white bg-blue-500 hover:bg-blue-600 font-medium rounded-lg text-sm px-2.5 py-2.5 w-full">Notificar evaluado</button>

                    <button (click)="NotifyEvaluator(item?.evaluador?.apellidosNombres,item?.evaluador?.codigoFicha)" *ngIf="DataType === 'CUMPLIMIENTO' && (item?.estadoEvaluado && !item?.estadoEvaluador) && !ReturnFormatedStatusDate(item?.fechaLimite).isPast"
                            class="text-white bg-blue-500 hover:bg-blue-600 font-medium rounded-lg text-sm px-2.5 py-2.5 w-full">Notificar evaluador</button>
                    
                    <button (click)="NotifyEvaluated(item?.evaluado?.apellidosNombres,item?.evaluado?.codigoFicha)" *ngIf="DataType === 'CUMPLIMIENTO' && (!item?.estadoEvaluado && !item?.estadoEvaluador) && !ReturnFormatedStatusDate(item?.fechaLimite).isPast"
                            class="text-white bg-blue-500 hover:bg-blue-600 font-medium rounded-lg text-sm px-2.5 py-2.5 w-full">Notificar evaluado</button>

                    <button type="button" *ngIf="!item?.estadoVeredicto &&  ReturnFormatedStatusDate(item?.fechaLimite).isPast" (click)="ShowModal(item)" class="text-white bg-gray-500 hover:bg-gray-600 font-medium rounded-lg text-sm px-2.5 py-2.5 w-full">Reprogramar excepción</button>
                </div>
            </td>
        </tr>
        <tr *ngIf="item?.evaluado?.codigoFicha && isRowExpanded(item?.evaluado?.codigoFicha)" class="bg-gray-50">
            <td colspan="10" class="px-6 py-4 text-black border">
              <div class="grid bg-gray-200 p-2 rounded-md">
                <div><strong>Administrador que autorizó la excepción: </strong> {{item?.evaluador?.apellidosNombres}}</div>
                <div><strong>Registro de excepción: </strong> {{item?.fechaRegistro | date: 'dd/MM/yyyy'}}</div>
              </div>
            </td>
        </tr>
    </ng-container> 
    </tbody>
</table>
</div>
</div> 

<app-changeexceptionlimitdates *ngIf="ShowChangeExceptionLimitDateModal" (close)="closeModal($event)" [PeriodCode]="this.CalendarCode" [EntryData]="this.EntryData"></app-changeexceptionlimitdates>